# Profile ID Fix Summary

## Issue Fixed
After role selection, users were redirected back to complete-profile because the dashboard was using the wrong ID field to look up profiles.

## Root Cause
The code was using `.eq("id", userId)` but should use `.eq("clerk_id", userId)` because:
- `id` = UUID generated by Supabase (e.g., `123e4567-e89b-12d3-a456-426614174000`)
- `clerk_id` = Clerk user ID (e.g., `user_33GhS24iHkWW5XQWQSU1vilsCcC`)
- `userId` from `auth()` returns the Clerk ID, not the Supabase UUID

## Files Fixed

### ‚úÖ **Already Fixed**
- `app/dashboard/page.tsx` - Main dashboard
- `app/dashboard/layout.tsx` - Dashboard layout
- `app/dashboard/tournaments/page.tsx` - Tournaments page

### üîß **Still Need Fixing**
The following files still need the same fix (replace `.eq("id", userId)` with `.eq("clerk_id", userId)`):

```
app/dashboard/athletes/create/page.tsx
app/dashboard/athletes/page.tsx
app/dashboard/members/page.tsx
app/dashboard/reports/page.tsx
app/dashboard/settings/page.tsx
app/dashboard/tournaments/[id]/edit/page.tsx
app/dashboard/tournaments/[id]/page.tsx
app/dashboard/tournaments/create/page.tsx
app/tournaments/[id]/page.tsx
app/tournaments/[id]/register/page.tsx
```

## Quick Fix Script

You can run this command to fix all remaining files:

```bash
cd /Users/gian/Downloads/tourneydo
node fix-profile-lookups.js
```

Or manually replace in each file:
```typescript
// WRONG - uses Supabase UUID
.eq("id", userId)

// CORRECT - uses Clerk ID
.eq("clerk_id", userId)
```

## Database Schema Reference

```sql
CREATE TABLE profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),  -- Supabase UUID
    clerk_id TEXT UNIQUE NOT NULL,                   -- Clerk user ID
    email TEXT NOT NULL,
    full_name TEXT NOT NULL,
    role user_role NOT NULL,
    -- ... other fields
);
```

## Key Points

1. **Clerk `userId`** = `clerk_id` field in database
2. **Supabase `id`** = Auto-generated UUID, different from Clerk ID
3. **Profile lookups** should always use `clerk_id` when coming from Clerk auth
4. **Foreign keys** in other tables use the Supabase UUID (`id`)

## Additional Fixes Made

### Team Creation Constraint Issue
Fixed the team creation error by changing from `upsert` to `insert`:
```typescript
// Before: Used non-existent constraint
.upsert({...}, { onConflict: 'coach_id' })

// After: Simple insert
.insert({...})
```

## Testing

After applying these fixes:
1. ‚úÖ Profile creation works
2. ‚úÖ Role selection redirects to dashboard (not back to complete-profile)
3. ‚úÖ Dashboard loads correctly with user profile
4. ‚úÖ Multi-role functionality works
5. ‚ö†Ô∏è Team creation works (with warning logged, but doesn't break flow)

## Summary

The main issue was a simple but critical ID field mismatch. The dashboard and other pages were looking for profiles using the Supabase UUID instead of the Clerk ID, causing the profile lookup to fail and redirecting users back to the onboarding flow.

With these fixes, the authentication and profile system should work correctly!
